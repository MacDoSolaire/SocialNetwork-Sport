{% extends "base.html.twig" %}

{% block title %}Commentaire{% endblock %}
{% block stylesheets %}
    <link rel="preconnect" href="https://fonts.gstatic.com/%22%3E">
    <link href="https://fonts.googleapis.com/css2?family=Rubik+Mono+One&display=swap" rel="stylesheet">
    <link href="{{ absolute_url(asset('css/publicationDetail.css')) }}" type="text/css" rel="stylesheet" />
{% endblock %}

{% block body %}
    <nav class="navbar">
        <ul>
            <a class="btn-feed" href="{{ path('index') }}"> Index</a>
            <a class ="btn-feed" href="{{ path('search_publication') }}">Rechercher</a>
            {% if app.user %}
                <a class="btn-feed" href="{{ path('app_logout') }}"> Deconnexion</a>
            {% else %}
                <a class="btn-feed" href="{{ path('app_login') }}"> Connexion</a>
            {% endif %}
            <a class="btn-profil"> <span class="iconify" data-inline="false" data-icon="vs:profile" style="font-size: 30px; margin-right: 7px;"></span> </a>
        </ul>
    </nav>

    <div class="feed">
        <div class="publier">
            <!-- Nom du membre -->
            <h3 class="membre">{{ publication.membre.prenom }} {{ publication.membre.nom }}</h3>

            <!-- date -->
            <span class="date">{{ publication.date|date('d/m/Y H:i:s') }}</span>

            <!-- message -->
            <p class="message">{{ publication.message }}</p>

            <a href="{{ path('publication_reply', {'publicationId': publication.id}) }}" class="comment">
                <i class="far fa-comment"></i>
                <span class="js-replies"> {{ publication.replies | length }}</span>
            </a>

            <a href="{{ path('publication_like', {'publicationId': publication.id}) }}" class="js-like">
                {% if app.user and publication.isLikedByMember(app.user) %}
                    <i class="fas fa-heart"></i>
                    <span class="js-likes"> {{ publication.publicationLikes | length }}</span>
                    <span class="js-label"> Je n'aime plus</span>
                {% else %}
                    <i class="far fa-heart"></i>
                    <span class="js-likes"> {{ publication.publicationLikes | length }}</span>
                    <span class="js-label"> J'aime</span>
                {% endif %}
            </a>
        </div>

        <div class="reply">
            {{ form_start(replyForm, {'attr': {'class': 'row'}}) }}
            <div class="msgPubli">
                {{ form_widget(replyForm.message, {'attr': { 'placeholder': 'Ecrivez votre r√©ponse'}}) }}
                <span class="error">{{ form_errors(replyForm.message) }}</span>
            </div>
            <input type="submit" name="" value="Envoyer" >
            {{ form_end(replyForm) }}
        </div>
    </div>

    <div class="feedReply">
        {% for reply in publication.replies %}
            <div class="reponse">
                 <h3 class="membre">{{ reply.membre.prenom }} {{ reply.membre.nom }}</h3>

                 <span class="date">{{ reply.date|date('d/m/Y H:i:s') }}</span>

                 <p class="message">{{ reply.message }}</p>
            <div>
        {% endfor %}
    </div>

{% endblock %}

{% block javascripts %}
    <script>
        document.querySelectorAll('a.js-like').forEach(function (link) {
            link.addEventListener("click", onBtnLikeClick);
        })

        function onBtnLikeClick(event) {
            event.preventDefault();

            const url = this.href;
            const spanCount = this.querySelector('span.js-likes');
            const spanText = this.querySelector('span.js-label');
            const icone = this.querySelector('i');

            fetch(url, { method: 'Post' })
                .then(response => response.json())
                .then(function (data){
                    spanCount.textContent = data.nbLike;

                    if (icone.classList.contains('fas')) {
                        icone.classList.replace('fas', 'far');
                        spanText.textContent = "J'aime";
                    } else {
                        icone.classList.replace('far', 'fas');
                        spanText.textContent = "Je n'aime plus";
                    }
                });
        }
    </script>
{% endblock %}