{% extends 'base.html.twig' %}

{% block title %}Profil{% endblock %}

{% block stylesheets %}
    <link rel="preconnect" href="https://fonts.gstatic.com/%22%3E">
    <link href="https://fonts.googleapis.com/css2?family=Rubik+Mono+One&display=swap" rel="stylesheet">
    <link  type="text/css" href="\css/profil_publication.css" rel="stylesheet">
{% endblock %}

{% block body %}
    {% include "profil/profil.html.twig" %}
    <div class="feed">

        {%  for publi in publi_profil %}
        <div class="publier">
            <!-- Nom du membre -->
            <h3 class="membre">{{ publi.membre.prenom }} {{ publi.membre.nom }}</h3>

            <!-- date -->
            <span class="date">{{ publi.date|date('d/m/Y H:i:s') }}</span>

            <!-- message -->
            <p class="message">{{ publi.message }}</p>

            <a  class="comment" href="{{ path('publication_reply', {'publicationId': publi.id}) }}">
                <i class="far fa-comment"></i>
                <span class="js-replies"> {{ publi.replies | length }}</span>
            </a>

            <a href="{{ path('publication_like', {'publicationId': publi.id}) }}" class="js-like">
                {% if app.user and publi.isLikedByMember(app.user) %}
                    <i class="fas fa-heart"></i>
                    <span class="js-likes"> {{ publi.publicationLikes | length }}</span>
                    <span class="js-label"> Je n'aime plus</span>
                {% else %}
                    <i class="far fa-heart"></i>
                    <span class="js-likes"> {{ publi.publicationLikes | length }}</span>
                    <span class="js-label"> J'aime</span>
                {% endif %}
            </a>
        </div>
        {% endfor %}

    </div>
{% endblock %}

{% block javascripts %}
    <script>
        document.querySelectorAll('a.js-like').forEach(function (link) {
            link.addEventListener("click", onBtnLikeClick);
        })

        document.querySelectorAll('a.js-join').forEach(function (link) {
            link.addEventListener("click", onBtnJoinClick);
        })

        function onBtnJoinClick(event) {
            event.preventDefault();

            const url = this.href;
            const spanCount = this.querySelector('span.js-joined');
            const icone = this.querySelector('i');

            fetch(url, { method: 'Post' })
                .then((response) => {
                    if (response.ok) {
                        return response.json();
                    }
                })
                .then(function (data){
                    const spanCountContent = data.nbParticipation;
                    if (spanCount.textContent !== spanCountContent) {
                        spanCount.textContent = spanCountContent;
                        if (icone.classList.contains('fas')) {
                            icone.classList.replace('fas', 'far');
                        } else {
                            icone.classList.replace('far', 'fas');
                        }
                    } else {
                        window.alert('Nombre maximum de participants atteint');
                    }
                });
        }

        function onBtnLikeClick(event) {
            event.preventDefault();

            const url = this.href;
            const spanCount = this.querySelector('span.js-likes');
            const spanText = this.querySelector('span.js-label');
            const icone = this.querySelector('i');

            fetch(url, { method: 'Post' })
                .then(response => response.json())
                .then(function (data){
                    spanCount.textContent = data.nbLike;

                    if (icone.classList.contains('fas')) {
                        icone.classList.replace('fas', 'far');
                        spanText.textContent = "J'aime";
                    } else {
                        icone.classList.replace('far', 'fas');
                        spanText.textContent = "Je n'aime plus";
                    }
                });
        }
    </script>
{% endblock %}